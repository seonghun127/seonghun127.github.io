<!DOCTYPE html><html><head><meta charset="UTF-8"><title> Spring Security OAuth2 </title><meta name="viewport" content="width=device-width, user-scalable=no"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="shortcut icon" href="/favicon.a35c33cf.ico" type="image/x-icon"><link rel="stylesheet" href="/init.366dd74d.css"><link rel="stylesheet" href="/article.3478855a.css"></head><body> <header id="top-container" role="navigation"> </header> <main id="main-container"> <article id="article-container"> <h1 id="article-title"> Spring Security OAuth2 </h1> <h2 id="article-subtitle"> spring security oauth2ì— ëŒ€í•´ ì•Œì•„ë³´ì </h2> <time id="article-date"> 2020.03.25 </time> <section id="article-content-container"> <h1>Spring Security OAuth2</h1>
<blockquote>
<p>http ì™„ë²½ê°€ì´ë“œ 12ì¥ ê¸°ë³¸ì¸ì¦ì„ ì½ë‹¤ê°€ github oauth2ì™€ spring securityë¥¼ ê³µë¶€í•˜ë©´ì„œ ì •ë¦¬í–ˆë˜ ê¸°ì–µì´ ë‚˜ì„œ ë‚´ìš©ì„ ì¢€ ë‹¤ë“¬ì–´ë³´ê³  ë¸”ë¡œê·¸ì— ì˜¬ë ¤ë³¸ë‹¤.</p>
</blockquote>
<p>ê¸°ë³¸ì ìœ¼ë¡œ <code>OAuth2</code> ë°©ì‹ì—ëŠ” 4ê°€ì§€ ë°©ì‹ì´ ìˆìŠµë‹ˆë‹¤.</p>
<ul>
<li>Authorization Code Grant</li>
<li>Implicit Grant</li>
<li>Resource Owner Password Credentials Grant</li>
<li>Client Credentials Grant</li>
</ul>
<h2>Authorization Code Grant Flow</h2>
<p>ê·¸ì¤‘ ì²«ë²ˆì§¸ì¸ <strong>Authorization Code Grant</strong> ë°©ì‹ì´ ì œì¼ ë§ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
<p><img src="https://user-images.githubusercontent.com/30451129/70374365-b0988200-1934-11ea-8c4d-e901c10af800.png" alt=""></p>
<ul>
<li>
<p>(A) <code>Resource Owner(ì‚¬ìš©ì)</code>ëŠ” <code>User-Agent(ë¸Œë¼ìš°ì €)</code>ë¥¼ í†µí•´ <code>Client(Application)</code>ì—ê²Œ <a href="http://domain.com/oauth2/authorization/github">domain.com/oauth2/authorization/github</a> ê²½ë¡œë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.</p>
</li>
<li>
<p>(A) <code>Client</code>ëŠ” ìœ„ ê²½ë¡œë¡œ ë“¤ì–´ì˜¨ ìš”ì²­ì— ëŒ€í•´ OAuth2 ì¸ì¦ ë°©ì‹ ìš”ì²­ì„ì„ í™•ì¸í•˜ê³  <code>Authorization Server(ê¶Œí•œ ì„œë²„, OAuth Provider ì„œë²„ : Github OAuth App Server)</code>ì—ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê²½ë¡œë¥¼ Location í•´ë”ì— ë‹´ì•„ ì‘ë‹µí•©ë‹ˆë‹¤. ì´ë•Œ ClientëŠ” Location ì •ë³´ë¡œ authorization-endpoint <a href="https://github.com/login/oauth/authorize">https://github.com/login/oauth/authorize</a>)ì™€ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ìœ¼ë¡œ Client Identifier (client-id), Redirection-URI(<a href="http://domain.com/login/oauth2/code/github">domain.com/login/oauth2/code/github</a>) ë“±(scope, stateâ€¦)ì„ ë‹´ì•„ì¤ë‹ˆë‹¤.</p>
</li>
<li>
<p>(A) 302 ë¦¬ë‹¤ì´ë ‰ì…˜ ì‘ë‹µì„ ë°›ì€ <code>User-Agent</code>ëŠ” Location ê²½ë¡œì— ì˜í•´ <code>Authorization Server</code>ì—ê²Œ ìš”ì²­ì„ ë³´ë‚´ê³  ì´ ê¶Œí•œ ì„œë²„ëŠ” ìœ„ì—ì„œ <code>Client</code>ê°€ ë‹´ì•„ë†“ì€ client-idë¥¼ í™•ì¸í•˜ì—¬ í•´ë‹¹ oauth appì˜ ê¶Œí•œ ìŠ¹ì¸ í˜ì´ì§€ë¡œ ì´ë™ì‹œì¼œì¤ë‹ˆë‹¤. (oauth2 providerì— ë¡œê·¸ì¸ ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´ ë¡œê·¸ì¸ì„ ë¨¼ì € í•˜ë¼ëŠ” í˜ì´ì§€ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.)</p>
</li>
<li>
<p>(B) <code>User-Agent</code>ì— ìŠ¹ì¸í˜ì´ì§€ê°€ ë„ìš°ê³  <code>Resource Owner</code>ëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ê±°ë‚˜ ê±°ì ˆí•©ë‹ˆë‹¤. ê¶Œí•œ ìŠ¹ì¸(ë˜ëŠ” ê±°ì ˆ) ì •ë³´ë¥¼ <code>Authorization Server</code>ì— ë³´ëƒ…ë‹ˆë‹¤.</p>
</li>
<li>
<p>Â© ë§Œì•½ <code>Resource Owner</code>ê°€ ê¶Œí•œ ìŠ¹ì¸í–ˆë‹¤ë©´ <code>Authorization Server</code>ëŠ” token(code)ì„ ë°œí–‰í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  <code>User-Agent</code>ë¥¼ ì´ì „ì— ì „ë‹¬ ë°›ì€ Redirect-URI ê²½ë¡œ(<a href="http://domain.com/login/oauth2/code/github">domain.com/login/oauth2/code/github</a>)ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œí‚µë‹ˆë‹¤. ì´ë•Œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ê²½ë¡œì— ë°œê¸‰í•œ í† í°ê³¼ ë”ë¶ˆì–´ ì´ì „ì— <code>Client</code>ê°€ ì „ë‹¬í•œ ì—¬ëŸ¬ ìƒíƒœ ê°’ì„ ê°™ì´ ë‹´ì•„ì¤ë‹ˆë‹¤.</p>
</li>
<li>
<p>(D) <code>User-Agent</code>ëŠ” <code>Client</code>ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë  ê²ƒì´ê³  <code>Client</code>ëŠ” ë‹¤ì‹œ <code>Authorization Server</code>ì—ê²Œ Token-URI(<a href="https://github.com/login/oauth/access_token">https://github.com/login/oauth/access_token</a>)ê²½ë¡œì— Post ìš”ì²­ìœ¼ë¡œ Access Tokenì„ ë‹¬ë¼ëŠ” ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. ì´ë•Œ Access Tokenì„ ë°œê¸‰í•˜ê¸°ìœ„í•œ ì¸ì¦ì„ ìœ„í•´ ì´ì „ì— ë°›ì€ token(code)ê³¼ ë”ë¶ˆì–´ <code>Authorization Server</code>ì— ë³´ëƒˆì—ˆë˜ ìƒíƒœê°’(client-id, client-secret, redirect-uri)ì„ ê°™ì´ ë³´ëƒ…ë‹ˆë‹¤.</p>
</li>
<li>
<p>(E) <code>Authorization Server</code>ëŠ” <code>Client</code>ê°€ ë³´ë‚¸ ê°’ì„ ê°€ì§€ê³  íƒ€ë‹¹í•œì§€ë¥¼ í™•ì¸í•˜ê³  ìœ íš¨í•œ ì •ë³´ê°€ í™•ì¸ëì„ ê²½ìš° Access Tokenì„ ë°œí–‰í•˜ì—¬ (ì„ íƒì ìœ¼ë¡œ Refresh Tokenë„ ê°™ì´ ë°œí–‰í•œë‹¤.) <code>Client</code>ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.</p>
<p><em>Â©ì—ì„œ ë°œí–‰í•œ tokenê³¼ (E)ì—ì„œ ë°œí–‰í•œ access tokenì€ ë‹¤ë¥¸ ê²ƒì…ë‹ˆë‹¤.</em></p>
</li>
<li>
<p>ì¶”ê°€ë¡œ <code>Client</code>ê°€ Access Tokenì„ ë°œê¸‰ ë°›ìœ¼ë©´ í•´ë‹¹ í† í°ì„ ì´ìš©í•˜ì—¬ <code>Resource Server</code>ì˜ user-Info-endpoint(<a href="https://api.github.com/user/%7Buser-id%7D">https://api.github.com/user/{user-id}</a>) ê²½ë¡œë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.</p>
</li>
</ul>
<h2>Spring Security + OAuth2</h2>
<h3>OAuth ì„¤ì •</h3>
<p>ì‚¬ì‹¤ìƒ Spring Securityì—ì„œ OAuth2ì—ì„œ í•„ìš”í•œ ì„¤ì •ì„ ëŒ€ë¶€ë¶„ í•´ì£¼ê³  ìˆìŠµë‹ˆë‹¤.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">package</span> org.springframework.security.config.oauth2.client;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> CommonOAuth2Provider {
    	...
    
    	GITHUB {
    
    		<span class="hljs-meta">@Override</span>
    		<span class="hljs-function"><span class="hljs-keyword">public</span> Builder <span class="hljs-title">getBuilder</span><span class="hljs-params">(String registrationId)</span> </span>{
    			ClientRegistration.Builder builder = getBuilder(registrationId,
    					ClientAuthenticationMethod.BASIC, DEFAULT_REDIRECT_URL);
    			builder.scope(<span class="hljs-string">"read:user"</span>);
    			builder.authorizationUri(<span class="hljs-string">"https://github.com/login/oauth/authorize"</span>);
    			builder.tokenUri(<span class="hljs-string">"https://github.com/login/oauth/access_token"</span>);
    			builder.userInfoUri(<span class="hljs-string">"https://api.github.com/user"</span>);
    			builder.userNameAttributeName(<span class="hljs-string">"id"</span>);
    			builder.clientName(<span class="hljs-string">"GitHub"</span>);
    			<span class="hljs-keyword">return</span> builder;
    		}
    	},
    
    	...
    }
</code></pre>
<p>ì´ë¯¸ Spring Securityê°€ ìœ„ <code>CommonOAuth2Provider</code> ì²˜ëŸ¼ OAuth ì—°ë™ì— í•„ìš”í•œ (github oauthì˜)ê¸°ë³¸ ì„¤ì • ì •ë³´ë¥¼ ë‹¤ ë§Œë“¤ì–´ë†”ì„œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
<p><strong>Authorization Code Grant Flow</strong>ì—ì„œ ì´ì•¼ê¸°í•œ <code>Authorization Server</code>ë¡œ ì ‘ê·¼í•˜ê¸° ìœ„í•œ authorization-endpoint, Access Tokenì„ ë°œê¸‰ë°›ê¸° ìœ„í•œ uri, ì¸ê°€ë¥¼ ë°›ê³  ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ê¸°ìœ„í•œ userInfo-endpoint ë“± <code>CommonOAuth2Provider.GITHUB</code> ì—ì„œ ì •ì˜ëœ ê°’ìœ¼ë¡œ ìë™ ì„¤ì •ëœ ê²ƒì…ë‹ˆë‹¤.</p>
<p>ì¶”ê°€ë¡œ ì²˜ìŒ ì‚¬ìš©ì(<code>Resource Owner</code>)ê°€ oauth ì¸ì¦ì„ í•˜ê¸°ìœ„í•œ ì‹œë„ì˜ ì‹œë°œì (A)ìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ” ê²½ë¡œ (<a href="http://domain.com/oauth2/authorization/github">http://domain.com/oauth2/authorization/github</a>) ë˜í•œ Spring Securityê°€ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì„¤ì • ê°’ì…ë‹ˆë‹¤.</p>
<p>ê·¸ë˜ì„œ ìš°ë¦¬ëŠ” ì•„ë˜ì²˜ëŸ¼ ë‘ê°€ì§€(client-id / client-secret)ë§Œ ì„¤ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤.</p>
<pre class="hljs"><code>    <span class="hljs-comment"># application.yml</span>
    
<span class="hljs-attr">    spring:</span>
<span class="hljs-attr">      security:</span>
<span class="hljs-attr">        oauth2:</span>
<span class="hljs-attr">          client:</span>
<span class="hljs-attr">            registration:</span>
<span class="hljs-attr">              github:</span>
<span class="hljs-attr">                client-id:</span> <span class="hljs-string">&lt;í´ë¼ì´ì–¸íŠ¸</span> <span class="hljs-string">ID&gt;</span>
<span class="hljs-attr">                client-secret:</span> <span class="hljs-string">&lt;í´ë¼ì´ì–¸íŠ¸</span> <span class="hljs-string">SECRET&gt;</span>
</code></pre>
<h3>OAuth ì ìš©</h3>
<pre class="hljs"><code>    <span class="hljs-meta">@EnableWebSecurity</span>
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{
    
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(<span class="hljs-keyword">final</span> HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>{
            http.authorizeRequests()
                    .antMatchers(<span class="hljs-string">"/"</span>).permitAll()
                    .anyRequest().authenticated()
                .and()
                    .oauth2Login();            <span class="hljs-comment">// ê¸°ë³¸ oauth login ì ìš©</span>
        }
    }
</code></pre>
<p><code>.oauth2Login()</code> ì„ ì ìš©í•¨ìœ¼ë¡œì¨ Spring Security ì— ìƒˆë¡œìš´ í•„í„°ê°€ ë‘ê°œê°€ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
<p>ì´ í•„í„°ê°€ OAuth2 ì ìš©ì„ ìœ„í•œ ì„¤ì •ê³¼ í†µì‹ ì„ ë‹´ë‹¹í•˜ê²Œ ë©ë‹ˆë‹¤.</p>
<pre class="hljs"><code>    org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter
    org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter
</code></pre>
<p>ìœ„ <strong>Authorization Code Grant Flow</strong> ì—ì„œ (A), (B), Â© ê¹Œì§€ <code>User-Agent(ë¸Œë¼ìš°ì €)</code>ì™€ <code>Authorization Server</code>ê°„ì˜ í†µì‹ ì´ì—ˆê³  (D), (E)ê°€ <code>Client</code>ì™€ <code>Authorization / Resource Server</code>ê°„ì˜ í†µì‹ ì…ë‹ˆë‹¤.</p>
<p><em>ë¸Œë¼ìš°ì €ë¥¼ í†µí•œ í†µì‹ ì€ ê·¸ë ‡ë‹¤ ì³ë„ ì„œë²„ê°„(<code>Client</code> - <code>Authorization Server</code>) í†µì‹ ì€ ì–´ë–»ê²Œ ì´ë¤„ì§ˆê¹Œ?</em></p>
<pre class="hljs"><code>    <span class="hljs-keyword">package</span> org.springframework.security.oauth2.client.endpoint;
    
    <span class="hljs-comment">// Access Token ë°œê¸‰ ê³¼ì •</span>
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultAuthorizationCodeTokenResponseClient</span> </span>{
    	...
    
    	<span class="hljs-meta">@Override</span>
    	<span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2AccessTokenResponse <span class="hljs-title">getTokenResponse</span><span class="hljs-params">(OAuth2AuthorizationCodeGrantRequest authorizationCodeGrantRequest)</span> </span>{
    		...
    		<span class="hljs-comment">// post request ìƒì„±</span>
    		<span class="hljs-comment">// public T convert(S s) {</span>
    		<span class="hljs-comment">//	...</span>
    		<span class="hljs-comment">//	// ê¸°ì¡´ì— Spring Securityê°€ ì„¤ì •í•œ token uri ê°’ì„ ë¶ˆëŸ¬ì™€ uri ê²½ë¡œë¡œ ì„¤ì •</span>
    		<span class="hljs-comment">//	URI uri = UriComponentsBuilder.fromUriString(clientRegistration.getProviderDetails().getTokenUri())</span>
    		<span class="hljs-comment">//		.build()</span>
    		<span class="hljs-comment">//		.toUri();</span>
    		<span class="hljs-comment">//	return new RequestEntity&lt;&gt;(formParameters, headers, HttpMethod.POST, uri);</span>
    		<span class="hljs-comment">// }</span>
    		RequestEntity&lt;?&gt; request = <span class="hljs-keyword">this</span>.requestEntityConverter.convert(authorizationCodeGrantRequest);
    
    		ResponseEntity&lt;OAuth2AccessTokenResponse&gt; response;
    		<span class="hljs-keyword">try</span> {
    			<span class="hljs-comment">// RestOperationì„ ì´ìš©í•œ í†µì‹ ì„ ì§„í–‰</span>
    			response = <span class="hljs-keyword">this</span>.restOperations.exchange(request, OAuth2AccessTokenResponse.class);
    		} <span class="hljs-keyword">catch</span> (RestClientException ex) {
    			OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(INVALID_TOKEN_RESPONSE_ERROR_CODE,
    					<span class="hljs-string">"An error occurred while attempting to retrieve the OAuth 2.0 Access Token Response: "</span> + ex.getMessage(), <span class="hljs-keyword">null</span>);
    			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthorizationException(oauth2Error, ex);
    		}
    
    		OAuth2AccessTokenResponse tokenResponse = response.getBody();
    
    		...
    	}
    
    	...
    }
</code></pre>
<p>ìœ„ ì½”ë“œì— ë‚˜ì™€ìˆë‹¤ì‹œí”¼ <code>this.requestEntityConverter.convert(authorizationCodeGrantRequest);</code> ë¥¼ í†µí•´ Http Requestë¥¼ Access Tokenì„ ë°œê¸‰ë°›ê¸° ìœ„í•œ ìš”ì²­ ê·œì•½ì— ë§ê²Œ ìƒì„±í•˜ê³  <code>this.restOperations.exchange(request, OAuth2AccessTokenResponse.class);</code> ë¡œ í†µì‹ ì„ í•˜ê²Œ ë©ë‹ˆë‹¤.</p>
<p><em><code>SecurityConfig</code> Spring Security ì„¤ì •ì—ì„œ <code>.oauth2Login()</code>ë§Œìœ¼ë¡œ ì„¤ì •í•´ë†¨ê¸° ë•Œë¬¸ì— Defaultë¡œ ì„¤ì •ëœ í´ë˜ìŠ¤<code>DefaultAuthorizationCodeTokenResponseClient</code>ì— ì˜í•´ oauth ì¸ì¦ - ì¸ê°€ê°€ ì²˜ë¦¬ë©ë‹ˆë‹¤.</em></p>
<pre class="hljs"><code>    <span class="hljs-keyword">package</span> org.springframework.security.oauth2.client.userinfo;
    
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultOAuth2UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OAuth2UserService</span>&lt;<span class="hljs-title">OAuth2UserRequest</span>, <span class="hljs-title">OAuth2User</span>&gt; </span>{
    	...
    	<span class="hljs-meta">@Override</span>
    	<span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2User <span class="hljs-title">loadUser</span><span class="hljs-params">(OAuth2UserRequest userRequest)</span> <span class="hljs-keyword">throws</span> OAuth2AuthenticationException </span>{
    		...
    		<span class="hljs-comment">// convert() ë¡œ request ìš”ì²­ ìƒì„±</span>
    		RequestEntity&lt;?&gt; request = <span class="hljs-keyword">this</span>.requestEntityConverter.convert(userRequest);
    
    		ResponseEntity&lt;Map&lt;String, Object&gt;&gt; response;
    
    		<span class="hljs-keyword">try</span> {
    			<span class="hljs-comment">// Authorization Serverì™€ í†µì‹ </span>
    			response = <span class="hljs-keyword">this</span>.restOperations.exchange(request, PARAMETERIZED_RESPONSE_TYPE);
    		} <span class="hljs-keyword">catch</span> (OAuth2AuthorizationException ex) {
    			...
    		}
    
    		Map&lt;String, Object&gt; userAttributes = response.getBody();
    		Set&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
    		authorities.add(<span class="hljs-keyword">new</span> OAuth2UserAuthority(userAttributes));
    		OAuth2AccessToken token = userRequest.getAccessToken();
    		<span class="hljs-keyword">for</span> (String authority : token.getScopes()) {
    			authorities.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(<span class="hljs-string">"SCOPE_"</span> + authority));
    		}
    
    		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultOAuth2User(authorities, userAttributes, userNameAttributeName);
    	}
    
    	...
    }
</code></pre>
<p>Access Tokenì„ ë°›ì•„ì˜¤ëŠ” ë°©ì‹ê³¼ ë¹„ìŠ·í•˜ê²Œ <code>DefaultOAuth2UserService</code>ì—ì„œ user-info-endpoint ê²½ë¡œë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">package</span> org.springframework.security.oauth2.client.userinfo;
    
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OAuth2UserRequestEntityConverter</span> </span>{
    	...
    
    	<span class="hljs-meta">@Override</span>
    	<span class="hljs-keyword">public</span> RequestEntity&lt;?&gt; convert(OAuth2UserRequest userRequest) {
    		ClientRegistration clientRegistration = userRequest.getClientRegistration();
    
    		...
    
    		HttpHeaders headers = <span class="hljs-keyword">new</span> HttpHeaders();
    		headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));
    
    		<span class="hljs-comment">// ê¸°ì¡´ì— Spring Securityê°€ ì„¤ì •í•œ user-info-endpointì˜ ê°’ì„ ë¶ˆëŸ¬ì™€ uri ê²½ë¡œ ì„¤ì •</span>
    		URI uri = UriComponentsBuilder.fromUriString(clientRegistration.getProviderDetails().getUserInfoEndpoint().getUri())
    				.build()
    				.toUri();
    
    		...
    
    		<span class="hljs-keyword">return</span> request;
    	}
    	...
    }
</code></pre>
<p><code>Client</code> - <code>Authorization Server</code> í†µì‹  ë‹´ë‹¹ í´ë˜ìŠ¤<br>
<em>ìœ„ì—ì„œ ì„¤ëª…í•œ Access Token ë°œê¸‰ ë¡œì§, ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ë¡œì§ì„ í˜¸ì¶œí•˜ëŠ” í´ë˜ìŠ¤ë‹¤.</em></p>
<pre class="hljs"><code>    <span class="hljs-keyword">package</span> org.springframework.security.oauth2.client.authentication;
    
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OAuth2LoginAuthenticationProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationProvider</span> </span>{
    	...
    	
    	<span class="hljs-meta">@Override</span>
    	<span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>{
    		
    		...
                OAuth2AccessTokenResponse accessTokenResponse;
		<span class="hljs-keyword">try</span> {
			OAuth2AuthorizationExchangeValidator.validate(
					authorizationCodeAuthentication.getAuthorizationExchange());
                        
                        <span class="hljs-comment">// access token ë°œê¸‰</span>
			accessTokenResponse = <span class="hljs-keyword">this</span>.accessTokenResponseClient.getTokenResponse(
					<span class="hljs-keyword">new</span> OAuth2AuthorizationCodeGrantRequest(
							authorizationCodeAuthentication.getClientRegistration(),
							authorizationCodeAuthentication.getAuthorizationExchange()));

		} <span class="hljs-keyword">catch</span> (OAuth2AuthorizationException ex) {
			OAuth2Error oauth2Error = ex.getError();
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());
		}

                <span class="hljs-comment">// ìœ„ì—ì„œ ë°›ì•„ì˜¨ accessToken ì¶”ì¶œ</span>
    		OAuth2AccessToken accessToken = accessTokenResponse.getAccessToken();
    		Map&lt;String, Object&gt; additionalParameters = accessTokenResponse.getAdditionalParameters();
    
    		<span class="hljs-comment">// ì¸ê°€ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜´ with accessToken</span>
    		OAuth2User oauth2User = <span class="hljs-keyword">this</span>.userService.loadUser(<span class="hljs-keyword">new</span> OAuth2UserRequest(
    				authorizationCodeAuthentication.getClientRegistration(), accessToken, additionalParameters));
    
    		...
    
    		<span class="hljs-comment">// ìœ„ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ ì €ì¥</span>
    		OAuth2LoginAuthenticationToken authenticationResult = <span class="hljs-keyword">new</span> OAuth2LoginAuthenticationToken(
    			authorizationCodeAuthentication.getClientRegistration(),
    			authorizationCodeAuthentication.getAuthorizationExchange(),
    			oauth2User,
    			mappedAuthorities,
    			accessToken,
    			accessTokenResponse.getRefreshToken());
    		authenticationResult.setDetails(authorizationCodeAuthentication.getDetails());
    
    		<span class="hljs-keyword">return</span> authenticationResult;
    	}
    
    	...
    }
</code></pre>
<p>ìœ„ì—ì„œ ì €ì¥ëœ<code>OAuth2LoginAuthenticationToken authenticationResult</code> ëŠ” ì¶”í›„ ì—¬ëŸ¬ ê¶Œí•œ ê°’ê³¼ í•¨ê»˜ <code>OAuth2AuthenticationToken</code> í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ê³  SecurityContextHolderì— ì €ì¥ë©ë‹ˆë‹¤.</p>
<p>SecurityContextHolderì— ë“±ë¡ëœ ì—¬ëŸ¬ ì»¨í…ìŠ¤íŠ¸ë“¤ì€ oauth ì¸ì¦ - ì¸ê°€ íë¦„ì— ë§ëŠ” ìƒëª…ì£¼ê¸°ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">package</span> com.gaejangmo.apiserver;
    
    <span class="hljs-meta">@ResController</span>
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Controller</span> </span>{
    
      <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/access_token"</span>)
      <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">index</span><span class="hljs-params">(OAuth2AuthenticationToken authenticationToken)</span> </span>{

    	<span class="hljs-comment">// SecurityContextHolderì— ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©</span>
        log.info(<span class="hljs-string">"authenticationToken {}"</span>, authenticationToken);
    
    	<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
      }
    }
</code></pre>
<p>ê·¸ë˜ì„œ ìœ„ì™€ ê°™ì´ ìš°ë¦¬ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ oauth ì¸ê°€ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” <code>OAuth2AuthenticationToken</code> ê°ì²´ë¥¼ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<h3>reference</h3>
<ul>
<li><a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></li>
</ul> </section> <section id="article-navigation"> <div class="article-navigation-item article-navigation-next"> <a href="/article/6.html"> <div class="article-navigation-arrow article-navigation-next">ï¼œ</div> <div class="article-navigation-content article-navigation-next"> <p class="article-navigation-title">Unique Index</p> <p class="article-navigation-subtitle">Indexë¥¼ ëª°ë¼ ë” ì‚½ì§ˆí–ˆë˜ Unique Index</p> </div> </a> </div> <div class="article-navigation-item article-navigation-prev"> <a href="/article/5.html"> <div class="article-navigation-arrow article-navigation-prev">ï¼</div> <div class="article-navigation-content article-navigation-prev"> <p class="article-navigation-title">Spring Redis</p> <p class="article-navigation-subtitle">springì—ì„œ redis ê°„ë‹¨í•œ ì‹¤ìŠµ</p> </div> </a> </div> </section> <section id="article-list-button-container"> <a href="/articles.html"> <div id="article-list-button">ğŸ“š</div> </a> </section> </article> </main> <script defer src="/init.7c7d4dd7.js"></script>
</body></html>